<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Senha | InterFix</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://kit.fontawesome.com/d6b6410536.js" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Bot√£o Voltar -->
    <a href="/login" class="back-button">
        <i class="fa-solid fa-arrow-left"></i>
        Voltar ao Login
    </a>

    <main class="container">
        <form class="login-box" id="formRecuperarSenha">
            <div class="login-form">
                <h1>
                    <i class="fa-solid fa-key"></i>
                    Recuperar Senha
                </h1>
                <p><strong>Esqueceu sua senha?</strong> N√£o se preocupe! Informe seus dados abaixo e enviaremos uma solicita√ß√£o ao administrador para redefinir sua senha.</p>
                
                <!-- Alertas -->
                <div id="mensagemAlerta" class="alert" style="display: none;"></div>
                
                <!-- Loading -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Enviando solicita√ß√£o...</p>
                </div>

                <!-- Formul√°rio -->
                <div id="formFields">
                    <p class="input-group">
                        <span class="icon"><i class="fa-solid fa-id-card"></i></span>
                        <input 
                            type="text" 
                            id="cpfRecuperacao" 
                            placeholder="Digite seu CPF"
                            maxlength="14"
                            required>
                    </p>
                    <p class="input-group">
                        <span class="icon"><i class="fa-solid fa-envelope"></i></span>
                        <input 
                            type="email" 
                            id="emailRecuperacao" 
                            placeholder="Digite seu e-mail cadastrado"
                            required>
                    </p>

                    <button type="submit" id="btnEnviar">
                        <i class="fa-solid fa-paper-plane"></i>
                        Solicitar Recupera√ß√£o
                    </button>
                </div>

                <!-- Informa√ß√µes -->
                <div class="info-box">
                    <h3><i class="fa-solid fa-circle-info"></i> Como funciona?</h3>
                    <ol>
                        <li>Informe seu CPF e e-mail cadastrados</li>
                        <li>Uma solicita√ß√£o ser√° enviada ao administrador</li>
                        <li>O administrador verificar√° sua identidade</li>
                        <li>Voc√™ receber√° uma senha tempor√°ria por e-mail</li>
                        <li>Altere a senha tempor√°ria no primeiro login</li>
                    </ol>
                </div>
            </div>

            <picture class="login-logo">
                <img src="/static/img/logo.png" alt="InterFix Logo">
                <img src="/static/img/logotipo-bg.png" alt="InterFix">
            </picture>
        </form>
    </main>

<script>
    // ============================================
    // FORMATA√á√ÉO DE CPF
    // ============================================
    const cpfInput = document.getElementById('cpfRecuperacao');
    const formRecuperarSenha = document.getElementById('formRecuperarSenha');

    cpfInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        }
    });

    // ============================================
    // FUN√á√ïES AUXILIARES
    // ============================================
    function mostrarMensagem(texto, tipo) {
        const alerta = document.getElementById('mensagemAlerta');
        alerta.textContent = texto;
        alerta.className = `alert ${tipo}`;
        alerta.style.display = 'block';
        
        setTimeout(() => {
            alerta.style.display = 'none';
        }, 5000);
    }

    function mostrarLoading(mostrar) {
        document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
        document.getElementById('formFields').style.display = mostrar ? 'none' : 'block';
        document.getElementById('btnEnviar').disabled = mostrar;
    }

    // ‚ö†Ô∏è FUN√á√ÉO VALIDAR CPF (COM VALIDA√á√ÉO R√çGIDA COMENTADA PARA TESTE)
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, ''); // Limpa o CPF

        // 1. Checa se o comprimento √© 11 (MANTIDO)
        if (cpf.length !== 11) return false;
        
        // ========================================================
        // ‚ùå VALIDA√á√ÉO R√çGIDA COMENTADA PARA PERMITIR TESTES
        // ========================================================
        
        // // Bloqueia CPFs com todos os d√≠gitos iguais (ex: 33333333333)
        // if (/^(\d)\1{10}$/.test(cpf)) return false; 
        
        // // L√≥gica de valida√ß√£o do primeiro d√≠gito verificador
        // let soma = 0;
        // for (let i = 0; i < 9; i++) {
        //     soma += parseInt(cpf.charAt(i)) * (10 - i);
        // }
        // let resto = 11 - (soma % 11);
        // let digito1 = resto >= 10 ? 0 : resto;
        
        // // L√≥gica de valida√ß√£o do segundo d√≠gito verificador
        // soma = 0;
        // for (let i = 0; i < 10; i++) {
        //     soma += parseInt(cpf.charAt(i)) * (11 - i);
        // }
        // resto = 11 - (soma % 11);
        // let digito2 = resto >= 10 ? 0 : resto;
        
        // // Retorna a checagem dos dois d√≠gitos verificadores
        // return digito1 === parseInt(cpf.charAt(9)) && digito2 === parseInt(cpf.charAt(10));
        
        // ========================================================
        // ‚úÖ RETORNO SIMPLIFICADO: RETORNA TRUE SE TIVER 11 D√çGITOS
        // ========================================================
        return true; 
    }
    
    // ... (restante do seu c√≥digo)
    
    function validarEmail(email) {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return regex.test(email);
    }

    function limparFormulario() {
        document.getElementById('cpfRecuperacao').value = '';
        document.getElementById('emailRecuperacao').value = '';
    }

    // ============================================
    // ‚úÖ ENVIO DO FORMUL√ÅRIO - URL CORRIGIDA
    // ============================================
    formRecuperarSenha.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        document.getElementById('mensagemAlerta').style.display = 'none';
        
        const cpfOriginal = cpfInput.value;
        const cpf = cpfOriginal.replace(/\D/g, '');
        const email = document.getElementById('emailRecuperacao').value.trim();
        
        console.log('üì§ Enviando dados:', { cpf, email });
        
        // Valida√ß√£o Front-end
        if (!validarCPF(cpf)) {
            mostrarMensagem('‚ùå CPF inv√°lido! Verifique e tente novamente.', 'error');
            cpfInput.focus();
            return;
        }
        
        if (!validarEmail(email)) {
            mostrarMensagem('‚ùå E-mail inv√°lido! Verifique e tente novamente.', 'error');
            document.getElementById('emailRecuperacao').focus();
            return;
        }
        
        mostrarLoading(true);
        
        try {
            // ‚úÖ URL CORRIGIDA: /api/recuperar/solicitar
            console.log('üåê Fazendo requisi√ß√£o para: /api/recuperar/solicitar');
            
            const response = await fetch('/api/recuperar/solicitar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cpf, email })
            });
            
            console.log('üì° Status da resposta:', response.status);
            
            const result = await response.json();
            console.log('üì¨ Resultado:', result);
            
            mostrarLoading(false);
            
            if (result.sucesso) {
                mostrarMensagem('‚úÖ ' + result.mensagem, 'success');
                limparFormulario();
                setTimeout(() => { 
                    window.location.href = '/login'; 
                }, 3000);
            } else {
                mostrarMensagem('‚ùå ' + result.mensagem, 'error');
            }
        } catch (error) {
            mostrarLoading(false);
            console.error('‚ùå Erro ao solicitar recupera√ß√£o:', error);
            mostrarMensagem('‚ùå Erro de conex√£o com o servidor. Tente novamente mais tarde.', 'error');
        }
    });
</script>
</body>
</html>